import java.io.FileReader;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpression;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;

import org.w3c.dom.Attr;
import org.w3c.dom.Document;
import org.w3c.dom.Node;
import org.w3c.dom.NodeList;
import org.xml.sax.InputSource;
import org.xml.sax.SAXException;


public class Extraction {

	public static void main(String argv[]) throws SAXException, IOException, XPathExpressionException, ParserConfigurationException {

		final String CDA_XPATH = "CDA_PATH";
		final String FHIR_XPATH = "FHIR_PATH";
		
		DocumentBuilderFactory documentumentBuilderFactory = DocumentBuilderFactory.newInstance();

		DocumentBuilder documentumentBuilder = documentumentBuilderFactory.newDocumentBuilder();
		Document cdaDocument = documentumentBuilder.parse("Rezept_mit_Verordnungen.xml");
 
		
		XPathFactory xpathFactory = XPathFactory.newInstance();
		XPath xpath = xpathFactory.newXPath();

	//XPathExpression expr = xpath.compile("/ClinicalDocument/recordTarget[1]/patientRole[1]/patient[1]/name[1]/given[2]");

		List<Map<String,String>> mappings = new ArrayList<Map<String,String>>();
		
		Map<String, String> patienFirstNameMapping = new HashMap<String, String>();
		
		patienFirstNameMapping.put(CDA_XPATH, "/ClinicalDocument/recordTarget[1]/patientRole[1]/patient[1]/name[1]/given[1]");
		patienFirstNameMapping.put(FHIR_XPATH, "/Patient/name[1]");
		
		Map<String, String> patienMiddleNameMapping = new HashMap<String, String>();
		
		patienMiddleNameMapping.put(CDA_XPATH, "/ClinicalDocument/recordTarget[1]/patientRole[1]/patient[1]/name[1]/given[2]");
		patienMiddleNameMapping.put(FHIR_XPATH, "/Patient/name[2]");
		

		mappings.add(patienFirstNameMapping);
		mappings.add(patienMiddleNameMapping);
		
		//Map CDA->FHIR
		for (Map<String, String> mapping:mappings) {
			//Get XPath for CDA Document
			String cdaPath = mapping.get(CDA_XPATH);
			String fhirPath = mapping.get(FHIR_XPATH);
			
			XPathExpression aexpr = xpath.compile(cdaPath);
			
			NodeList firstNameNode = (NodeList) aexpr.evaluate(cdaDocument, XPathConstants.NODESET);
			//firstNameNode.("Rudi");
			
			String val = firstNameNode.item(0).getNodeValue();

			
			
			for(int i = 0; i< firstNameNode.getLength(); i++) {
				
				Object obj = firstNameNode.item(i);

				if (obj instanceof Node) {
					System.out.println("NODE");
				} else if (obj instanceof NodeList) {
						System.out.println("NODEList");
					} 

				System.out.println("BLA :"+firstNameNode.item(i).getNodeValue());	
			}
			
			
			//Read value from CDA Document
			String value = aexpr.evaluate(cdaDocument);
			
		
			System.out.println("VAL :"+value);
			/*
			//write to XML file
			XPathFactory factory = XPathFactory.newInstance();
		    XPath xPath = factory.newXPath();
		    Attr result = (Attr) xPath.evaluate(FHIR_XPATH, new InputSource(
		    new FileReader("file.xml")), XPathConstants.NODE);
		    System.out.println(result);
		    
		    */

		    //result.setValue("The Colbert Report");

		  }
			
		}
	}

